// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// MULTI-TENANCY CORE
// --------------------------------------------------------

model Tenant {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  code            String   @unique
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  settings        Json?

  // Relations
  users           User[]
  employees       Employee[]
  departments     Department[]
  designations    Designation[]
  branches        Branch[]
  locations       Location[]
  devices         Device[]
  attendanceLogs  AttendanceLog[]
  shifts          Shift[]
  employeeShifts  EmployeeShift[]
  leaves          Leave[]
  leaveBalances   LeaveBalance[]
  holidays        Holiday[]
  payrollRuns     PayrollRun[]
  salaryComponents SalaryComponent[]
  salaryStructures SalaryStructure[]
  payrollSettings  PayrollSetting[]
  fieldLogs       FieldLog[]
  projects        Project[]
  deviceCommands  DeviceCommand[]
  categories      Category[]
  leaveTypes      LeaveType[]
  
  // Implicit relations needing explicit fields
  employeeSalaryComponents EmployeeSalaryComponent[]
  payslips                 Payslip[]
  rawDeviceLogs            RawDeviceLog[]
  syncLogs                 SyncLog[]
}

// --------------------------------------------------------
// USER & AUTH
// --------------------------------------------------------

model User {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  username  String
  email     String?
  password  String
  role      String   @default("user") // admin, manager, employee, hr, superadmin
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  employeeId String? @unique
  employee   Employee? @relation(fields: [employeeId], references: [id])

  RefreshToken RefreshToken[]

  @@unique([username, tenantId])
  @@index([tenantId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// --------------------------------------------------------
// ORGANIZATION STRUCTURE
// --------------------------------------------------------

model Branch {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]
  departments Department[]

  @@unique([code, tenantId])
}

model Location {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  address     String?
  latitude    Float?
  longitude   Float?
  radius      Int      @default(100) // Geofence radius in meters
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]

  @@unique([code, tenantId])
}

model Department {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  managers    Employee[] @relation("DeptManagers")
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[] @relation("EmployeeDept")

  @@unique([code, branchId, tenantId])
}

model Designation {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]

  @@unique([code, tenantId])
}

model Category {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([code, tenantId])
}

// --------------------------------------------------------
// EMPLOYEE MANAGEMENT
// --------------------------------------------------------

model Employee {
  id              String           @id @default(uuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  employeeCode    String
  firstName       String
  lastName        String?
  email           String?
  phone           String?
  gender          String?
  dateOfBirth     DateTime?
  address         String?
  
  // Employment Details
  branchId        String?
  branch          Branch?          @relation(fields: [branchId], references: [id])
  departmentId    String?
  department      Department?      @relation("EmployeeDept", fields: [departmentId], references: [id])
  designationId   String?
  designation     Designation?     @relation(fields: [designationId], references: [id])
  locationId      String?
  location        Location?        @relation(fields: [locationId], references: [id])
  
  reportToId      String?
  reportTo        Employee?        @relation("ReportTo", fields: [reportToId], references: [id])
  subordinates    Employee[]       @relation("ReportTo")

  managerOfDeptId String?
  managerOfDept   Department?      @relation("DeptManagers", fields: [managerOfDeptId], references: [id])

  // Biometric & System
  deviceUserId    String?
  sourceEmployeeId String?
  dateOfJoining   DateTime?
  status          String           @default("active") // active, resigned, terminated
  
  user            User?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  attendanceLogs  AttendanceLog[]
  employeeShifts  EmployeeShift[]
  salaryStructure SalaryStructure?
  payslips        Payslip[]
  leaves          Leave[]
  leaveBalances   LeaveBalance[]
  fieldLogs       FieldLog[]

  @@unique([employeeCode, tenantId])
  @@unique([sourceEmployeeId, tenantId])
}

// --------------------------------------------------------
// ATTENDANCE & SHIFTS
// --------------------------------------------------------

model Shift {
  id              String    @id @default(uuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  name            String
  code            String?
  startTime       DateTime  @db.Time
  endTime         DateTime  @db.Time
  breakDuration   Int       @default(60) // in minutes
  gracePeriodIn   Int       @default(0)
  gracePeriodOut  Int       @default(0)
  isNightShift    Boolean   @default(false)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  employeeShifts  EmployeeShift[]

  @@unique([code, tenantId])
}

model EmployeeShift {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  shiftId     String
  shift       Shift     @relation(fields: [shiftId], references: [id])
  startDate   DateTime
  endDate     DateTime? // Null means ongoing
  isDefault   Boolean   @default(false)
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
}

model AttendanceLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  date        DateTime @db.Date // key for the day
  firstIn     DateTime?
  lastOut     DateTime?
  totalHours  Float    @default(0)
  workingHours Float   @default(0)
  lateArrival Float    @default(0)
  earlyDeparture Float @default(0)
  status      String   @default("Absent") // Present, Absent, Half Day, Late, Holiday, WeekOff
  
  logs        String?  // JSON array of all raw punch times for investigation
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([employeeId, date, tenantId])
}

model Holiday {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  date        DateTime @db.Date
  type        String   @default("Public") // Public, Company, etc.
  description String?
  isRecurring Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  @@unique([date, tenantId])
}

// --------------------------------------------------------
// LEAVE MANAGEMENT
// --------------------------------------------------------

model LeaveType {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  isPaid      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([code, tenantId])
}

model Leave {
  id           String       @id @default(uuid())
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id])
  leaveType    String       // CL, PL, SL, etc
  startDate    DateTime
  endDate      DateTime
  reason       String?
  status       String       @default("pending") // pending, approved, rejected
  approvedBy   String?
  updatedAt    DateTime     @updatedAt

  @@index([tenantId])
}

model LeaveBalance {
  id           String       @id @default(uuid())
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  code         String
  description  String?
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id])
  year         Int
  total        Float        @default(0)
  used         Float        @default(0)
  balance      Float        @default(0)
  
  leaveEntries LeaveEntry[]

  @@unique([code, employeeId, year, tenantId])
}

model LeaveEntry {
  id             String       @id @default(uuid())
  leaveBalanceId String
  leaveBalance   LeaveBalance @relation(fields: [leaveBalanceId], references: [id])
  date           DateTime
  type           String       // CREDIT, DEBIT
  amount         Float
  reason         String?
  createdAt      DateTime     @default(now())
}

// --------------------------------------------------------
// PAYROLL SYSTEM
// --------------------------------------------------------

model SalaryComponent {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  name              String
  code              String   // e.g., BASIC, HRA, PF_EMP
  type              String   // EARNING, DEDUCTION
  calculationType   String   // FLAT, PERCENTAGE, FORMULA
  value             Float?   // For flat/percentage
  formula           String?  // e.g., "BASIC * 0.12"
  isActive          Boolean  @default(true)
  
  employeeLinks     EmployeeSalaryComponent[]

  @@unique([code, tenantId])
}

model SalaryStructure {
  id                String          @id @default(uuid())
  tenantId          String
  tenant            Tenant          @relation(fields: [tenantId], references: [id])
  employeeId        String          @unique
  employee          Employee        @relation(fields: [employeeId], references: [id])
  grossSalary       Float           @default(0)
  netSalary         Float           @default(0) // Estimated
  components        EmployeeSalaryComponent[] // Overrides or specific values
  isActive          Boolean         @default(true)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
}

model EmployeeSalaryComponent {
  id                String          @id @default(uuid())
  tenantId          String
  tenant            Tenant          @relation(fields: [tenantId], references: [id])
  structureId       String
  structure         SalaryStructure @relation(fields: [structureId], references: [id])
  componentId       String
  component         SalaryComponent @relation(fields: [componentId], references: [id])
  amount            Float           // The calculated or override amount
  formula           String?         // Optional override formula
  
  @@unique([structureId, componentId])
}

model PayrollSetting {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  key               String   // e.g., PF_LIMIT, ESI_LIMIT, PT_SLABS
  value             String   // JSON string of config
  description       String?
  updatedAt         DateTime @updatedAt

  @@unique([key, tenantId])
}

model PayrollRun {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  month             Int
  year              Int
  status            String    @default("DRAFT") // DRAFT, LOCKED, PROCESSED, PAID
  processedAt       DateTime?
  approvedAt        DateTime?
  totalPayout       Float     @default(0)
  totalEmployees    Int       @default(0)
  payslips          Payslip[]
  createdAt         DateTime  @default(now())

  @@unique([month, year, tenantId])
}

model Payslip {
  id              String           @id @default(uuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  name            String
  payrollRunId    String
  payrollRun      PayrollRun       @relation(fields: [payrollRunId], references: [id])
  employeeId      String
  employee        Employee         @relation(fields: [employeeId], references: [id])
  
  grossSalary     Float
  totalDeductions Float
  netSalary       Float
  
  details         String           // JSON Blob of all components (Basic: 5000, HRA: 2000, etc) for freezing history
  
  generatedAt     DateTime         @default(now())

  @@unique([employeeId, payrollRunId])
}

// --------------------------------------------------------
// DEVICE & SYNC
// --------------------------------------------------------

model Device {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  name            String
  protocol        String         @default("ESSL_ADMS") // ESSL_ADMS, MATRIX_DIRECT, REALTIME_DIRECT, HIKVISION_DIRECT, SQL_MIRROR
  ipAddress       String?
  port            Int?
  serialNumber    String
  username        String?
  password        String?
  location        String?
  status          String         @default("offline")
  lastSeen        DateTime?
  config          String?        // JSON for extra properties (e.g. SQL Table name)
  
  rawDeviceLogs   RawDeviceLog[]
  commands        DeviceCommand[]

  @@unique([serialNumber, tenantId])
}

model RawDeviceLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id])
  
  deviceUserId String
  timestamp    DateTime
  type         String?  // CheckIn, CheckOut, etc.
  
  isProcessed  Boolean  @default(false)
  processedAt  DateTime?
  
  createdAt    DateTime @default(now())

  @@unique([deviceId, deviceUserId, timestamp, tenantId])
  @@index([isProcessed])
  @@index([tenantId])
}

model DeviceCommand {
  id           String    @id @default(uuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  deviceId     String
  device       Device    @relation(fields: [deviceId], references: [id])
  command      String
  status       String    @default("pending")
  response     String?   // Device response if any
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sentAt       DateTime?

  @@index([deviceId, status])
  @@index([tenantId])
}

model SyncLog {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  status        String   // SUCCESS, FAILED
  message       String?
  recordCount   Int      @default(0)
  lastSyncTime  DateTime
  createdAt     DateTime @default(now())

  @@index([tenantId])
}

model FieldLog {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee  @relation(fields: [employeeId], references: [id])
  projectId         String?
  project           Project?  @relation(fields: [projectId], references: [id])
  
  type              String    @default("CHECK_IN") // CHECK_IN, CHECK_OUT
  timestamp         DateTime  @default(now())
  
  checkInTime       DateTime?
  checkInLocation   String?   // JSON {lat, lng, address}
  checkInImage      String?
  
  checkOutTime      DateTime?
  checkOutLocation  String?
  checkOutImage     String?
  
  durationMinutes   Int?
  distanceTraveled  Float?    // in km
  
  notes             String?
  remarks           String?
  status            String    @default("PENDING") // PENDING, APPROVED, REJECTED
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([employeeId, checkInTime, tenantId])
}

model Project {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  clientName  String?
  startDate   DateTime?
  endDate     DateTime?
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED, ON_HOLD
  
  latitude    Float?
  longitude   Float?
  radius      Int       @default(200) // Geofence radius
  
  fieldLogs   FieldLog[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([code, tenantId])
}
