// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// MULTI-TENANCY CORE
// --------------------------------------------------------

model Tenant {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  code            String   @unique
  domain          String?  @unique
  type            String   @default("CORPORATE") // CORPORATE, SCHOOL
  plan            String   @default("free") // free, pro, enterprise
  modules         String[] @default(["attendance", "leaves", "employees"]) 
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  settings        Json?

  // Relations
  academicSessions AcademicSession[]
  students         Student[]
  guardians        Guardian[]
  courses          Course[]
  batches          Batch[]
  subjects         Subject[]

  // Relations
  users           User[]
  employees       Employee[]
  departments     Department[]
  designations    Designation[]
  branches        Branch[]
  locations       Location[]
  devices         Device[]
  attendanceLogs  AttendanceLog[]
  shifts          Shift[]
  employeeShifts  EmployeeShift[]
  leaveBalances   LeaveBalance[]
  holidays        Holiday[]
  payrollRuns     PayrollRun[]
  salaryComponents SalaryComponent[]
  payrollSettings  PayrollSetting[]
  fieldLogs       FieldLog[]
  projects        Project[]
  documents       EmployeeDocument[]
  loans           Loan[]
  loanDeductions  LoanDeduction[]
  deviceCommands  DeviceCommand[]
  categories      Category[]
  leaveTypes      LeaveType[]
  leaveEntries    LeaveEntry[]
  
  // Implicit relations needing explicit fields
  employeeSalaryComponents EmployeeSalaryComponent[]
  payslips                 Payslip[]
  rawDeviceLogs            RawDeviceLog[]
  syncLogs                 SyncLog[]
  auditLogs                AuditLog[]
  payrolls                 Payroll[]
  companyProfile           CompanyProfile?
  
  // Asset Management
  assetCategories          AssetCategory[]
  assets                   Asset[]
  assetAssignments         AssetAssignment[]
  assetRequests            AssetRequest[]
  maintenanceLogs          MaintenanceLog[]
  vendors                  Vendor[]
  
  // Payroll Enhancements
  ctcStructures            CTCStructure[]
  reimbursementEntries     ReimbursementEntry[]
  salaryRevisions          SalaryRevision[]
  tdsDeclarations          TDSDeclaration[]
  
  // School Finance
  feeHeads                 FeeHead[]
  feeStructures            FeeStructure[]
  feeRecords               FeeRecord[]
  deviceLogs               DeviceLog[]
  
  // School Academic
  timetableEntries         TimetableEntry[]
  studentAttendance        StudentAttendance[]
  examMarks                ExamMark[]
  studentDocuments         StudentDocument[]
  studentFieldLogs         StudentFieldLog[]
  
  // School Services
  transportRoutes          TransportRoute[]
  libraryBooks             LibraryBook[]
  
  // Recruitment
  jobOpenings              JobOpening[]
  candidates               Candidate[]
  
  // Performance
  goals                    Goal[]
  feedbacks                Feedback[]
  appraisals               Appraisal[]
  
  // Communication
  announcements            Announcement[]
  notifications            Notification[]
  
  // Training (LMS)
  trainingCourses          TrainingCourse[]
  trainingSessions         TrainingSession[]
  
  // Helpdesk
  tickets                  Ticket[]
  
  // Visitor Management
  visitors                 VisitorLog[]
  
  // Onboarding
  onboardingTasks          OnboardingTask[]
}

// --------------------------------------------------------
// USER & AUTH
// --------------------------------------------------------

model User {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  username  String
  email     String?
  password  String
  role      String   @default("user") // admin, manager, employee, hr, superadmin
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  employeeId String? @unique
  employee   Employee? @relation(fields: [employeeId], references: [id])

  RefreshToken RefreshToken[]
  auditLogs    AuditLog[]

  @@unique([username, tenantId])
  @@index([tenantId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// --------------------------------------------------------
// ORGANIZATION STRUCTURE
// --------------------------------------------------------

model Branch {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]
  departments Department[]
  locationId  String?
  location    Location? @relation(fields: [locationId], references: [id])

  @@unique([code, tenantId])
}

model Location {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  latitude    Float?
  longitude   Float?
  radius      Int      @default(100) // Geofence radius in meters
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]
  branches    Branch[]

  @@unique([code, tenantId])
}

model Department {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  managers    Employee[] @relation("DeptManagers")
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[] @relation("EmployeeDept")

  @@unique([code, branchId, tenantId])
}

model Designation {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]

  @@unique([code, tenantId])
}

model Category {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]

  @@unique([code, tenantId])
}

// --------------------------------------------------------
// EMPLOYEE MANAGEMENT
// --------------------------------------------------------

model Employee {
  id              String           @id @default(uuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  employeeCode    String
  firstName       String
  lastName        String?
  email           String?
  phone           String?
  gender          String?
  dateOfBirth     DateTime?
  address         String?
  city            String?
  state           String?  // For PT calculation (KA, MH, WB, TN, etc.)
  pincode         String?
  
  // Employment Details
  branchId        String?
  branch          Branch?          @relation(fields: [branchId], references: [id])
  departmentId    String?
  department      Department?      @relation("EmployeeDept", fields: [departmentId], references: [id])
  designationId   String?
  designation     Designation?     @relation(fields: [designationId], references: [id])
  locationId      String?
  location        Location?        @relation(fields: [locationId], references: [id])
  
  reportToId      String?
  reportTo        Employee?        @relation("ReportTo", fields: [reportToId], references: [id])
  subordinates    Employee[]       @relation("ReportTo")

  managerOfDeptId String?
  managerOfDept   Department?      @relation("DeptManagers", fields: [managerOfDeptId], references: [id])

  // Biometric & System
  deviceUserId    String?
  sourceEmployeeId String?
  dateOfJoining   DateTime?
  status          String           @default("active") // active, resigned, terminated
  
  user            User?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  isActive        Boolean          @default(true)
  bankName        String?
  categoryId      String?
  category        Category?        @relation(fields: [categoryId], references: [id])
  shiftId         String?
  shift           Shift?           @relation(fields: [shiftId], references: [id])
  
  // Legacy Salary Fields
  basicSalary       Float            @default(0)
  hra               Float            @default(0)
  otherAllowances   Float            @default(0)
  monthlyCtc        Float            @default(0) // New: Master CTC field
  retentionAmount   Float            @default(0) // New: Monthly retention
  standardDeductions Float           @default(0) 
  isOTEnabled       Boolean          @default(true)
  otRateMultiplier Float           @default(1.0)
  isPFEnabled     Boolean          @default(true)
  isESIEnabled    Boolean          @default(true)
  isPTEnabled     Boolean          @default(true)
  
  // Bank & IDs
  accountNumber   String?
  ifscCode        String?
  panNumber       String?
  aadhaarNumber   String?
  cardNumber      String? // For biometric cards
  
  attendanceLogs  AttendanceLog[]
  employeeShifts  EmployeeShift[]
  payslips        Payslip[]
  leaveEntries    LeaveEntry[]
  managedLeaves   LeaveEntry[] @relation("ManagerLeaveApproval")
  ceoLeaves       LeaveEntry[] @relation("CeoLeaveApproval")
  leaveBalances   LeaveBalance[]
  fieldLogs       FieldLog[]
  payrolls        Payroll[]
  salaryComponents EmployeeSalaryComponent[]
  documents       EmployeeDocument[]
  loans           Loan[]
  assetAssignments AssetAssignment[]
  assetRequests    AssetRequest[]
  ctcStructures    CTCStructure[]
  reimbursementEntries ReimbursementEntry[]
  salaryRevisions  SalaryRevision[]

  tdsDeclarations  TDSDeclaration[]
  
  // Performance
  goals            Goal[]
  feedbacksGiven   Feedback[] @relation("FeedbackFrom")
  feedbacksReceived Feedback[] @relation("FeedbackTo")
  appraisals       Appraisal[]
  
  // Visitor Management
  hostedVisitors   VisitorLog[] @relation("HostVisitor")
  
  // Onboarding
  onboardingTasks  OnboardingTask[]
  
  // Helpdesk
  tickets          Ticket[]
  
  // School Academic & Devices
  batchesManaged   Batch[]
  timetableEntries TimetableEntry[]
  deviceLogs       DeviceLog[]

  @@unique([employeeCode, tenantId])
  @@unique([sourceEmployeeId, tenantId])
}

// --------------------------------------------------------
// ATTENDANCE & SHIFTS
// --------------------------------------------------------

model Shift {
  id              String    @id @default(uuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  name            String
  code            String?
  startTime       DateTime  @db.Time
  endTime         DateTime  @db.Time
  breakDuration   Int       @default(60) // in minutes
  gracePeriodIn   Int       @default(0)
  gracePeriodOut  Int       @default(0)
  isNightShift    Boolean   @default(false)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  employees       Employee[]

  employeeShifts  EmployeeShift[]

  @@unique([code, tenantId])
}

model EmployeeShift {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  shiftId     String
  shift       Shift     @relation(fields: [shiftId], references: [id])
  startDate   DateTime
  endDate     DateTime? // Null means ongoing
  isDefault   Boolean   @default(false)
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
}

model AttendanceLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  date        DateTime @db.Date // key for the day
  firstIn     DateTime?
  lastOut     DateTime?
  totalHours  Float    @default(0)
  workingHours Float   @default(0)
  lateArrival Float    @default(0)
  earlyDeparture Float @default(0)
  status      String   @default("Absent") // Present, Absent, Half Day, Late, Holiday, WeekOff
  
  logs        String?  // JSON array of all raw punch times for investigation
  totalPunches Int     @default(0)
  shiftStart   DateTime?
  shiftEnd     DateTime?
  rawData      String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([employeeId, date, tenantId])
}

model Holiday {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  date        DateTime @db.Date
  type        String   @default("Public") // Public, Company, etc.
  description String?
  isRecurring Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  @@unique([date, tenantId])
}

// --------------------------------------------------------
// LEAVE MANAGEMENT
// --------------------------------------------------------

model LeaveType {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  isPaid      Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  leaveEntries LeaveEntry[]

  @@unique([code, tenantId])
}

model LeaveEntry {
  id                String       @id @default(uuid())
  tenantId          String
  tenant            Tenant       @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee     @relation(fields: [employeeId], references: [id])
  leaveTypeId       String?
  leaveType         LeaveType?   @relation(fields: [leaveTypeId], references: [id])
  startDate         DateTime
  endDate           DateTime
  days              Int          @default(1)
  reason            String?
  status            String       @default("pending") // pending, pending_manager, pending_ceo, approved, rejected
  
  managerApproval   Boolean      @default(false)
  managerApprovedAt DateTime?
  managerId         String?
  manager           Employee?    @relation("ManagerLeaveApproval", fields: [managerId], references: [id])
  
  ceoApproval       Boolean      @default(false)
  ceoApprovedAt     DateTime?
  ceoId             String?
  ceo               Employee?    @relation("CeoLeaveApproval", fields: [ceoId], references: [id])
  
  rejectionReason   String?
  updatedAt         DateTime     @updatedAt

  @@index([tenantId])
}

model LeaveBalance {
  id           String       @id @default(uuid())
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  code         String
  description  String?
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id])
  year         Int
  total        Float        @default(0)
  used         Float        @default(0)
  balance      Float        @default(0)
  
  transactions LeaveBalanceTransaction[]

  @@unique([code, employeeId, year, tenantId])
}

model LeaveBalanceTransaction {
  id             String       @id @default(uuid())
  leaveBalanceId String
  leaveBalance   LeaveBalance @relation(fields: [leaveBalanceId], references: [id])
  date           DateTime
  type           String       // CREDIT, DEBIT
  amount         Float
  reason         String?
  createdAt      DateTime     @default(now())
}

// --------------------------------------------------------
// PAYROLL SYSTEM
// --------------------------------------------------------

model SalaryComponent {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  name              String
  code              String   // e.g., BASIC, HRA, PF_EMP
  type              String   // EARNING, DEDUCTION
  calculationType   String   // FLAT, PERCENTAGE, FORMULA
  value             Float?   // For flat/percentage
  formula           String?  // e.g., "BASIC * 0.12"
  isActive          Boolean  @default(true)
  
  employeeLinks     EmployeeSalaryComponent[]

  @@unique([code, tenantId])
}

model EmployeeSalaryComponent {
  id                String          @id @default(uuid())
  tenantId          String
  tenant            Tenant          @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee        @relation(fields: [employeeId], references: [id])
  componentId       String
  component         SalaryComponent @relation(fields: [componentId], references: [id])
  monthlyAmount     Float           @default(0)
  isActive          Boolean         @default(true)
  formula           String?
  
  @@unique([employeeId, componentId])
}

model PayrollSetting {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  key               String   // e.g., PF_LIMIT, ESI_LIMIT, PT_SLABS
  value             String   // JSON string of config
  description       String?
  updatedAt         DateTime @updatedAt

  @@unique([key, tenantId])
}

model PayrollRun {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  month             Int
  year              Int
  periodStart       DateTime?
  periodEnd         DateTime?
  status            String    @default("DRAFT") // DRAFT, LOCKED, PROCESSED, PAID
  processedAt       DateTime?
  processedBy       String?
  approvedAt        DateTime?
  totalNet          Float     @default(0)
  totalEmployees    Int       @default(0)
  totalGross        Float     @default(0)
  batchName         String?
  approvedBy        String?
  payrolls          Payroll[]
  payslips          Payslip[]
  createdAt         DateTime  @default(now())

  @@unique([month, year, tenantId])
}

model Payslip {
  id              String           @id @default(uuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  name            String
  payrollRunId    String
  payrollRun      PayrollRun       @relation(fields: [payrollRunId], references: [id])
  employeeId      String
  employee        Employee         @relation(fields: [employeeId], references: [id])
  
  grossSalary     Float
  totalDeductions Float
  netSalary       Float
  
  details         String           // JSON Blob of all components (Basic: 5000, HRA: 2000, etc) for freezing history
  
  generatedAt     DateTime         @default(now())

  @@unique([employeeId, payrollRunId])
}

// --------------------------------------------------------
// DEVICE & SYNC
// --------------------------------------------------------

model Device {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  name            String
  protocol        String         @default("ESSL_ADMS") // ESSL_ADMS, MATRIX_DIRECT, REALTIME_DIRECT, HIKVISION_DIRECT, SQL_MIRROR
  ipAddress       String?
  port            Int?
  deviceId        String
  username        String?
  password        String?
  location        String?
  status          String         @default("offline")
  isActive        Boolean        @default(true)
  lastSeen        DateTime?
  config          String?        // JSON for extra properties (e.g. SQL Table name)
  
  rawDeviceLogs   RawDeviceLog[]
  commands        DeviceCommand[] // Relation to DeviceCommand
  deviceLogs      DeviceLog[]

  @@unique([deviceId, tenantId])
}

model RawDeviceLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id])
  
  deviceUserId String
  userId       String?   // Legacy/Alternative field
  userName     String?   // Capture name for identity verification
  timestamp    DateTime
  punchTime    DateTime? // Legacy/Alternative field
  punchType    String?  // CheckIn, CheckOut, etc.
  
  isProcessed  Boolean  @default(false)
  processedAt  DateTime?
  
  createdAt    DateTime @default(now())

  @@unique([deviceId, deviceUserId, timestamp, tenantId])
  @@index([isProcessed])
  @@index([tenantId])
  @@index([userId])
  @@index([punchTime])
}

model DeviceCommand {
  id           String    @id @default(uuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  deviceId     String
  device       Device    @relation(fields: [deviceId], references: [id])
  
  commandType  String    // Was 'command'
  payload      String?   @db.Text
  status       String    @default("PENDING")
  priority     Int       @default(1)
  
  response     String?   // Device response if any
  result       String?   @db.Text // JSON Result
  error        String?   @db.Text
  
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sentAt       DateTime?
  completedAt  DateTime?

  @@index([deviceId, status])
  @@index([tenantId])
}
model SyncLog {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  status        String   // SUCCESS, FAILED
  message       String?
  recordCount   Int      @default(0)
  lastSyncTime  DateTime
  createdAt     DateTime @default(now())

  @@index([tenantId])
}

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  action      String
  module      String
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  details     String?  // JSON
  description String?  // Adding description as it's used in ceo.ts
  createdAt   DateTime @default(now())

  @@index([tenantId])
}

model Payroll {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee  @relation(fields: [employeeId], references: [id])
  month             Int
  year              Int
  totalWorkingDays  Int       @default(0)
  actualPresentDays Float     @default(0)
  lopDays           Float     @default(0)
  paidDays          Float     @default(0)
  
  // Earnings
  grossSalary       Float     @default(0)
  basicPaid         Float     @default(0)
  hraPaid           Float     @default(0)
  allowancesPaid    Float     @default(0)
  otHours           Float     @default(0)
  otPay             Float     @default(0)
  bonus             Float     @default(0)
  incentives        Float     @default(0)
  leaveEncashment   Float     @default(0)
  reimbursements    Float     @default(0)
  arrears           Float     @default(0)
  
  // Deductions
  totalDeductions   Float     @default(0)
  pfDeduction       Float     @default(0)
  esiDeduction      Float     @default(0)
  ptDeduction       Float     @default(0)
  tdsDeduction      Float     @default(0)
  loanDeduction     Float     @default(0)
  advanceDeduction  Float     @default(0)
  otherDeductions   Float     @default(0)
  
  // Employer Contributions
  employerPF        Float     @default(0)
  employerESI       Float     @default(0)
  gratuityAccrual   Float     @default(0)
  
  // Final
  netSalary         Float     @default(0)
  details           String?   @db.Text    // New: Stores JSON breakdown
  retentionDeduction Float     @default(0)
  finalTakeHome     Float     @default(0) // New: Take home after retention
  
  // Status & Control
  status            String    @default("generated") // generated, review, approved, paid, hold
  isHold            Boolean   @default(false)
  holdReason        String?
  
  // State for PT
  stateCode         String?   // KA, MH, WB, TN, etc.
  
  // Relations
  payrollRunId      String?
  payrollRun        PayrollRun? @relation(fields: [payrollRunId], references: [id])
  loanDeductions    LoanDeduction[]
  reimbursementEntries ReimbursementEntry[]
  
  // Metadata
  processedAt       DateTime?
  approvedAt        DateTime?
  approvedBy        String?
  paidAt            DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@unique([employeeId, month, year, tenantId])
  @@index([tenantId, month, year])
  @@index([status])
}

model Loan {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee       @relation(fields: [employeeId], references: [id])
  amount          Float          // Principal
  interestRate    Float          @default(0)
  tenureMonths    Int
  monthlyDeduction Float
  startDate       DateTime
  status          String         @default("ACTIVE") // ACTIVE, COMPLETED, CLOSED
  
  repaidAmount    Float          @default(0)
  balanceAmount   Float
  
  deductions      LoanDeduction[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}

model LoanDeduction {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  loanId          String
  loan            Loan           @relation(fields: [loanId], references: [id])
  payrollId       String
  payroll         Payroll        @relation(fields: [payrollId], references: [id])
  amount          Float
  date            DateTime       @default(now())

  @@index([loanId])
}

model CompanyProfile {
  id             String   @id @default(uuid())
  tenantId       String   @unique
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  name           String
  legalName      String?
  logo           String?
  address        String?
  city           String?
  state          String?
  country        String?
  pincode        String?
  phone          String?
  email          String?
  website        String?
  taxId          String? // Generic Tax ID
  registrationId String? // Generic Registration ID
  
  // Specific Indian Compliance Fields
  gstin          String?
  pan            String?
  pfCode         String?
  esiCode        String?
  tan            String?
  
  // Bank Details
  bankName       String?
  accountNumber  String?
  ifscCode       String?
  
  updatedAt      DateTime @updatedAt
}

model FieldLog {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee  @relation(fields: [employeeId], references: [id])
  projectId         String?
  project           Project?  @relation(fields: [projectId], references: [id])
  
  type              String    @default("IN") // IN or OUT
  timestamp         DateTime  @default(now())
  
  location          String?   // JSON {lat, lng, address}
  image             String?   // Base64 or URL
  remarks           String?
  status            String    @default("pending") // pending, approved, rejected
  
  approvedBy        String?
  approvedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId])
}

model Project {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  clientName  String?
  startDate   DateTime?
  endDate     DateTime?
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED, ON_HOLD
  
  latitude    Float?
  longitude   Float?
  radius      Int       @default(200) // Geofence radius
  
  fieldLogs   FieldLog[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([code, tenantId])
}

model EmployeeDocument {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  type        String   // Offer Letter, ID Proof, etc.
  name        String   // Display Name
  url         String   // File Path relative to uploads/
  mimeType    String?
  size        Int?
  
  uploadedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}

// --------------------------------------------------------
// ASSET MANAGEMENT
// --------------------------------------------------------

model AssetCategory {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  assets      Asset[]
  assetRequests    AssetRequest[]

  @@unique([name, tenantId])
  @@index([tenantId])
}

model Asset {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  categoryId    String
  category      AssetCategory @relation(fields: [categoryId], references: [id])
  
  name          String
  code          String   // Unique Asset Code / Barcode
  description   String?
  serialNumber  String?
  brand         String?
  model         String?
  purchaseDate  DateTime?
  purchaseCost  Float?
  currency      String   @default("INR")
  vendorName    String?
  warrantyExpiry DateTime?
  
  status        String   @default("AVAILABLE") // AVAILABLE, ASSIGNED, REPAIR, RETIRED, LOST
  condition     String   @default("GOOD") // NEW, GOOD, FAIR, POOR, DAMAGED
  
  parentAssetId String?
  parentAsset   Asset?    @relation("SubAssets", fields: [parentAssetId], references: [id])
  subAssets     Asset[]   @relation("SubAssets")
  
  vendorId      String?
  vendor        Vendor?   @relation(fields: [vendorId], references: [id])
  
  assignments   AssetAssignment[]
  maintenanceLogs MaintenanceLog[]
  
  qrCode        String?  // URL or Base64 of QR/Barcode
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([code, tenantId])
  @@index([tenantId])
  @@index([categoryId])
}

model AssetAssignment {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  assetId     String
  asset       Asset     @relation(fields: [assetId], references: [id])
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  
  assignedDate DateTime @default(now())
  returnDate   DateTime?
  expectedReturnDate DateTime?
  
  remarks      String?
  returnCondition String?
  
  status       String   @default("ACTIVE") // ACTIVE, RETURNED
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId])
  @@index([assetId])
  @@index([employeeId])
}

model Vendor {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  name            String
  contactPerson   String?
  email           String?
  phone           String?
  address         String?
  taxId           String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  assets          Asset[]

  @@unique([name, tenantId])
  @@index([tenantId])
}

model AssetRequest {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  assetCategoryId String
  category        AssetCategory @relation(fields: [assetCategoryId], references: [id])
  
  description     String?
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH, URGENT
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED, ALLOCATED, CANCELLED
  
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
}

model MaintenanceLog {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id])
  
  type            String   // REPAIR, SERVICE, UPGRADE, INSPECTION
  description     String
  cost            Float    @default(0)
  startDate       DateTime
  endDate         DateTime?
  
  performedBy     String?  // Vendor name or Internal technician
  status          String   @default("COMPLETED") // IN_PROGRESS, COMPLETED, CANCELLED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([assetId])
}

// --------------------------------------------------------
// PAYROLL ENHANCEMENTS
// --------------------------------------------------------

model CTCStructure {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  effectiveFrom DateTime
  effectiveTo   DateTime?
  
  // CTC Breakdown (Monthly)
  basicSalary      Float
  hra              Float
  specialAllowance Float  @default(0)
  conveyance       Float  @default(0)
  medical          Float  @default(0)
  lta              Float  @default(0)
  otherAllowances  Float  @default(0)
  
  // Employer Contributions (Monthly)
  employerPF       Float  @default(0)
  employerESI      Float  @default(0)
  gratuity         Float  @default(0)
  
  // Totals
  totalMonthlyGross Float
  totalAnnualCTC    Float
  
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
  @@index([effectiveFrom])
}

model ReimbursementEntry {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  payrollId   String?
  payroll     Payroll? @relation(fields: [payrollId], references: [id])
  
  type        String   // TRAVEL, MEDICAL, FOOD, INTERNET, MOBILE, etc.
  amount      Float
  billDate    DateTime
  billNumber  String?
  description String?
  attachment  String?  // File path or URL
  
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED, PAID
  approvedBy  String?
  approvedAt  DateTime?
  rejectedReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([payrollId])
}

model SalaryRevision {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  oldCTC      Float
  newCTC      Float
  oldBasic    Float
  newBasic    Float
  
  effectiveFrom DateTime
  reason      String?  // PROMOTION, ANNUAL_INCREMENT, MARKET_CORRECTION, etc.
  
  approvedBy  String?
  approvedAt  DateTime?
  
  createdAt   DateTime @default(now())

  @@index([tenantId])
  @@index([employeeId])
}

model TDSDeclaration {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  financialYear String  // e.g. "2025-26"
  
  // Section 80C (Max 1.5L)
  ppf         Float    @default(0)
  elss        Float    @default(0)
  lifeInsurance Float  @default(0)
  homeLoanPrincipal Float @default(0)
  tuitionFees Float    @default(0)
  nsc         Float    @default(0)
  
  // Other Sections
  section80D  Float    @default(0) // Health Insurance
  section80E  Float    @default(0) // Education Loan Interest
  section80G  Float    @default(0) // Donations
  section24   Float    @default(0) // Home Loan Interest
  
  // HRA Details
  rentPaid    Float    @default(0)
  landlordPAN String?
  
  // Regime
  taxRegime   String   @default("OLD") // OLD or NEW
  
  status      String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED
  submittedAt DateTime?
  approvedAt  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([employeeId, financialYear, tenantId])
  @@index([tenantId])
  @@index([employeeId])
}

// --------------------------------------------------------


model DeviceLog {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  deviceId        String?
  device          Device?  @relation(fields: [deviceId], references: [id])
  
  employeeId      String?
  employee        Employee? @relation(fields: [employeeId], references: [id])
  
  deviceUserId    String   // User ID from device
  punchTime       DateTime
  punchType       String   // IN, OUT
  
  source          String   @default("DEVICE") // DEVICE, MANUAL, MOBILE
  verifyMode      Int?     // 0=Password, 1=Fingerprint, 3=Card, 15=Face
  
  rawData         String?  @db.Text
  
  processed       Boolean  @default(false)
  processedAt     DateTime?
  
  createdAt       DateTime @default(now())
  
  @@index([deviceId])
  @@index([employeeId])
  @@index([punchTime])
  @@index([processed])
}


// --------------------------------------------------------
// SCHOOL MANAGEMENT MODULES (PHASE 1)
// --------------------------------------------------------

// ACADEMIC STRUCTURE
model AcademicSession {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name            String   // e.g. "2025-2026"
  code            String?  // e.g. "25-26"
  startDate       DateTime
  endDate         DateTime
  isCurrent       Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  students        Student[]
  batches         Batch[]
  
  @@index([tenantId])
}

model Course {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name            String   // e.g. "Class 10", "B.Tech CSE"
  code            String?
  description     String?
  duration        Int?     // Duration in months/years
  type            String?  // "CLASS", "DEGREE", "DIPLOMA"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  batches         Batch[]
  subjects        Subject[]
  feeStructures   FeeStructure[]
  
  @@unique([tenantId, name])
  @@index([tenantId])
}

model Batch {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  courseId        String
  course          Course   @relation(fields: [courseId], references: [id])
  
  sessionId       String
  session         AcademicSession @relation(fields: [sessionId], references: [id])
  
  name            String   // e.g. "Section A", "2025 Batch"
  maxStrength     Int?
  
  inchargeId      String?  // Class Teacher (Employee)
  incharge        Employee? @relation(fields: [inchargeId], references: [id])
  
  startDate       DateTime?
  endDate         DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  students        Student[]
  timetable       TimetableEntry[]
  
  @@index([tenantId])
  @@index([courseId])
  @@index([sessionId])
}

model Subject {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  courseId        String?
  course          Course?  @relation(fields: [courseId], references: [id])
  
  name            String   // e.g. "Mathematics", "Physics"
  code            String?
  type            String   @default("THEORY") // THEORY, PRACTICAL
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  timetable       TimetableEntry[]
  examMarks       ExamMark[]
  
  @@index([tenantId])
  @@index([courseId])
}

// STUDENT MANAGEMENT
model Student {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  sessionId       String
  session         AcademicSession @relation(fields: [sessionId], references: [id])
  
  // Basic Info
  firstName       String
  lastName        String
  admissionNo     String   // Unique per tenant
  rollNo          String?
  email           String?
  phone           String?
  gender          String?
  dob             DateTime?
  bloodGroup      String?
  biometricId     String?  // ID used in Biometric Device/RFID Card
  
  // Academic Class/Section
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])
  
  // Parent/Guardian
  guardianId      String?
  guardian        Guardian? @relation(fields: [guardianId], references: [id])
  
  // Tracking
  dateOfAdmission DateTime
  status          String   @default("ACTIVE") // ACTIVE, ALUMNI, TRANSFERRED, SUSPENDED
  
  address         String?
  city            String?
  state           String?
  zipCode         String?
  
  photo           String?
  
  // School Services Links
  transportRouteId String?
  transportRoute   TransportRoute? @relation(fields: [transportRouteId], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  attendance      StudentAttendance[]
  fees            FeeRecord[]
  examMarks       ExamMark[]
  documents       StudentDocument[]
  fieldLogs       StudentFieldLog[]
  
  @@unique([tenantId, admissionNo])
  @@index([tenantId])
  @@index([batchId])
  @@index([guardianId])
}

model Guardian {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  firstName       String
  lastName        String
  relation        String   // FATHER, MOTHER, GUARDIAN
  desc            String?  // Description/Occupation
  
  email           String?
  phone           String
  altPhone        String?
  
  address         String?
  
  userId          String?  // Link to User login (if parent portal enabled)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  students        Student[]
  
  @@index([tenantId])
  @@index([phone])
}

model StudentDocument {
  id              String   @id @default(uuid())
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  title           String   // e.g. "Transfer Certificate"
  type            String   // PDF, IMAGE
  url             String
  
  uploadedAt      DateTime @default(now())
  
  @@index([studentId])
  @@index([tenantId])
}

// ACADEMIC OPERATIONS
model TimetableEntry {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  batchId         String
  batch           Batch    @relation(fields: [batchId], references: [id])
  
  subjectId       String
  subject         Subject  @relation(fields: [subjectId], references: [id])
  
  teacherId       String?
  teacher         Employee? @relation(fields: [teacherId], references: [id])
  
  dayOfWeek       Int      // 0=Sun, 1=Mon...
  startTime       String   // "09:00"
  endTime         String   // "10:00"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([batchId])
  @@index([teacherId])
}

model StudentAttendance {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  date            DateTime
  status          String   // PRESENT, ABSENT, LATE, LEAVE
  
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([studentId, date])
  @@index([date])
}

model ExamMark {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  subjectId       String
  subject         Subject  @relation(fields: [subjectId], references: [id])
  
  examName        String   // "Mid Term", "Finals"
  marksObtained   Float
  totalMarks      Float
  grade           String?
  
  date            DateTime
  
  @@index([studentId])
  @@index([subjectId])
}

model FeeHead {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name            String   // e.g. "Tuition Fee", "Transport Fee"
  type            String   @default("RECURRING") // RECURRING, ONE_TIME
  frequency       String?  // MONTHLY, QUARTERLY, ANNUALLY (if recurring)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  structures      FeeStructure[]
  
  @@unique([tenantId, name])
}

model FeeStructure {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  courseId        String?
  course          Course?  @relation(fields: [courseId], references: [id])
  
  headId          String
  head            FeeHead  @relation(fields: [headId], references: [id])
  
  amount          Float
  dueDateOffset   Int?     // Days after session start or specific Day of month
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  feeRecords      FeeRecord[]
}

model FeeRecord {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  structureId     String?
  structure       FeeStructure? @relation(fields: [structureId], references: [id])
  
  title           String   // "Tuition Fee - Q1"
  amount          Float
  dueDate         DateTime
  
  status          String   @default("PENDING") // PENDING, PAID, OVERDUE, PARTIAL
  
  paidAmount      Float    @default(0)
  paidDate        DateTime?
  paymentMode     String?  // CASH, ONLINE, CHEQUE
  transactionId   String?
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([studentId])
  @@index([status])
}

// --------------------------------------------------------
// SCHOOL SERVICES: TRANSPORT & LIBRARY
// --------------------------------------------------------

model TransportRoute {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String   // "Route 1", "North Bus"
  vehicleNo   String?
  driverName  String?
  driverPhone String?
  
  students    Student[]
  fieldLogs   StudentFieldLog[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model LibraryBook {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  title       String
  author      String?
  isbn        String?
  category    String?
  quantity    Int      @default(1)
  available   Int      @default(1)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
}

model StudentFieldLog {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  type            String   // PICKUP, DROP, TRIP_CHECKIN, TRIP_CHECKOUT
  timestamp       DateTime @default(now())
  
  location        String?  // JSON string {lat, lng, address}
  image           String?  // Base64 or URL
  remarks         String?
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  
  routeId         String?
  route           TransportRoute? @relation(fields: [routeId], references: [id])
  
  approvedBy      String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([studentId])
  @@index([routeId])
}

// --------------------------------------------------------
// RECRUITMENT (ATS)
// --------------------------------------------------------

model JobOpening {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  title           String
  department      String?
  location        String?
  type            String   // FULL_TIME, PART_TIME, CONTRACT
  experience      String?
  salaryRange     String?
  description     String?  @db.Text
  status          String   @default("OPEN") // OPEN, CLOSED, ON_HOLD
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  candidates      Candidate[]

  @@index([tenantId])
}

model Candidate {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  jobId           String
  job             JobOpening @relation(fields: [jobId], references: [id])
  
  firstName       String
  lastName        String
  email           String
  phone           String
  resumeUrl       String?
  status          String   @default("NEW") // NEW, SHORTLISTED, INTERVIEW, OFFER, HIRED, REJECTED
  
  source          String?  // LinkedIn, Referral, etc.
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([jobId])
}

// --------------------------------------------------------
// PERFORMANCE MANAGEMENT
// --------------------------------------------------------

model Goal {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  title           String
  description     String?
  category        String   @default("INDIVIDUAL") // INDIVIDUAL, DEPARTMENT, CORPORATE
  startDate       DateTime
  dueDate         DateTime
  progress        Int      @default(0) // 0-100
  status          String   @default("ON_TRACK") // ON_TRACK, AT_RISK, DELAYED, COMPLETED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}

model Feedback {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  fromEmployeeId  String
  fromEmployee    Employee @relation("FeedbackFrom", fields: [fromEmployeeId], references: [id])
  toEmployeeId    String
  toEmployee      Employee @relation("FeedbackTo", fields: [toEmployeeId], references: [id])
  
  content         String   @db.Text
  type            String   @default("GENERAL") // POSITIVE, IMPROVEMENT, GENERAL
  
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([toEmployeeId])
}

model Appraisal {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  periodStart     DateTime
  periodEnd       DateTime
  rating          Float?
  managerComment  String?  @db.Text
  employeeComment String?  @db.Text
  status          String   @default("DRAFT") // DRAFT, SELF_APPRAISAL, MANAGER_REVIEW, COMPLETED
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}

// --------------------------------------------------------
// COMMUNICATION & ANNOUNCEMENTS
// --------------------------------------------------------

model Announcement {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  title           String
  content         String   @db.Text
  category        String   @default("GENERAL") // HOLIDAY, POLICY, EVENT, GENERAL
  priority        String   @default("NORMAL") // LOW, NORMAL, HIGH
  
  expiresAt       DateTime?
  publishedAt     DateTime @default(now())
  
  createdAt       DateTime @default(now())

  @@index([tenantId])
}

model Notification {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  userId          String?
  // We can target specific users or everyone in the tenant
  
  title           String
  message         String
  type            String   // INFO, WARNING, ATTENDANCE, LEAVE, PAYROLL
  isRead          Boolean  @default(false)
  link            String?  // Optional URL to redirect to
  
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
}

// --------------------------------------------------------
// TRAINING & LMS
// --------------------------------------------------------

model TrainingCourse {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  title           String
  description     String?  @db.Text
  category        String?  // Technical, Soft Skills, Compliance
  duration        String?  // e.g. "4 Hours", "2 Days"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  sessions        TrainingSession[]

  @@index([tenantId])
}

model TrainingSession {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  courseId        String
  course          TrainingCourse @relation(fields: [courseId], references: [id])
  
  trainerName     String?
  scheduledAt     DateTime
  location        String?  // Meeting link or Room name
  status          String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  
  // We can track attendees if we link to Employees, but for now simple sessions
  createdAt       DateTime @default(now())

  @@index([tenantId])
  @@index([courseId])
}

// --------------------------------------------------------
// HELPDESK & TICKETING
// --------------------------------------------------------

model Ticket {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  subject         String
  description     String   @db.Text
  category        String   @default("HR") // HR, IT, FINANCE, ADMIN
  priority        String   @default("MEDIUM") // LOW, MEDIUM, HIGH, CRITICAL
  status          String   @default("OPEN") // OPEN, IN_PROGRESS, RESOLVED, CLOSED
  
  assignedTo      String?  // Name or User ID of resolver
  resolution      String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
}

// --------------------------------------------------------
// VISITOR MANAGEMENT
// --------------------------------------------------------

model VisitorLog {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  
  fullName        String
  phone           String?
  email           String?
  company         String?
  purpose         String   // Interview, Meeting, Delivery, personal, etc.
  
  hostId          String?  // Employee they are visiting
  host            Employee? @relation("HostVisitor", fields: [hostId], references: [id])
  
  checkIn         DateTime @default(now())
  checkOut        DateTime?
  
  idProofType     String?
  idProofNumber   String?
  
  status          String   @default("IN") // IN, OUT
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([hostId])
}

// --------------------------------------------------------
// ONBOARDING & OFFBOARDING
// --------------------------------------------------------

model OnboardingTask {
  id              String   @id @default(uuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  title           String
  description     String?
  category        String   @default("GENERAL") // IT, HR, FINANCE, ADMIN
  dueDate         DateTime?
  
  status          String   @default("PENDING") // PENDING, COMPLETED, NOT_APPLICABLE
  completedAt     DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}


model HikvisionLog {
  id              String   @id @default(uuid())
  person_id       String?
  access_datetime String?
  access_date     String?
  access_time     String?
  auth_result     String?
  device_name     String?
  serial_no       String?
  person_name     String?
  emp_dept        String?
  card_no         String?
  direction       String?
  mask_status     String?
  
  is_processed    Boolean  @default(false)
  created_at      DateTime @default(now())

  @@map("HikvisionLogs")
}

