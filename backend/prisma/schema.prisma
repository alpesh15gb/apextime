// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// MULTI-TENANCY CORE
// --------------------------------------------------------

model Tenant {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  code            String   @unique
  domain          String?  @unique
  plan            String   @default("free") // free, pro, enterprise
  modules         String[] @default(["attendance", "leaves", "employees"]) 
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  settings        Json?

  // Relations
  users           User[]
  employees       Employee[]
  departments     Department[]
  designations    Designation[]
  branches        Branch[]
  locations       Location[]
  devices         Device[]
  attendanceLogs  AttendanceLog[]
  shifts          Shift[]
  employeeShifts  EmployeeShift[]
  leaveBalances   LeaveBalance[]
  holidays        Holiday[]
  payrollRuns     PayrollRun[]
  salaryComponents SalaryComponent[]
  payrollSettings  PayrollSetting[]
  fieldLogs       FieldLog[]
  projects        Project[]
  documents       EmployeeDocument[]
  loans           Loan[]
  loanDeductions  LoanDeduction[]
  deviceCommands  DeviceCommand[]
  categories      Category[]
  leaveTypes      LeaveType[]
  leaveEntries    LeaveEntry[]
  
  // Implicit relations needing explicit fields
  employeeSalaryComponents EmployeeSalaryComponent[]
  payslips                 Payslip[]
  rawDeviceLogs            RawDeviceLog[]
  syncLogs                 SyncLog[]
  auditLogs                AuditLog[]
  payrolls                 Payroll[]
  companyProfile           CompanyProfile?
}

// --------------------------------------------------------
// USER & AUTH
// --------------------------------------------------------

model User {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  username  String
  email     String?
  password  String
  role      String   @default("user") // admin, manager, employee, hr, superadmin
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  employeeId String? @unique
  employee   Employee? @relation(fields: [employeeId], references: [id])

  RefreshToken RefreshToken[]
  auditLogs    AuditLog[]

  @@unique([username, tenantId])
  @@index([tenantId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

// --------------------------------------------------------
// ORGANIZATION STRUCTURE
// --------------------------------------------------------

model Branch {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  address     String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]
  departments Department[]
  locationId  String?
  location    Location? @relation(fields: [locationId], references: [id])

  @@unique([code, tenantId])
}

model Location {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String?
  address     String?
  city        String?
  state       String?
  country     String?
  zipCode     String?
  latitude    Float?
  longitude   Float?
  radius      Int      @default(100) // Geofence radius in meters
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]
  branches    Branch[]

  @@unique([code, tenantId])
}

model Department {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  managers    Employee[] @relation("DeptManagers")
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[] @relation("EmployeeDept")

  @@unique([code, branchId, tenantId])
}

model Designation {
  id          String     @id @default(uuid())
  tenantId    String
  tenant      Tenant     @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]

  @@unique([code, tenantId])
}

model Category {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  employees   Employee[]

  @@unique([code, tenantId])
}

// --------------------------------------------------------
// EMPLOYEE MANAGEMENT
// --------------------------------------------------------

model Employee {
  id              String           @id @default(uuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  employeeCode    String
  firstName       String
  lastName        String?
  email           String?
  phone           String?
  gender          String?
  dateOfBirth     DateTime?
  address         String?
  
  // Employment Details
  branchId        String?
  branch          Branch?          @relation(fields: [branchId], references: [id])
  departmentId    String?
  department      Department?      @relation("EmployeeDept", fields: [departmentId], references: [id])
  designationId   String?
  designation     Designation?     @relation(fields: [designationId], references: [id])
  locationId      String?
  location        Location?        @relation(fields: [locationId], references: [id])
  
  reportToId      String?
  reportTo        Employee?        @relation("ReportTo", fields: [reportToId], references: [id])
  subordinates    Employee[]       @relation("ReportTo")

  managerOfDeptId String?
  managerOfDept   Department?      @relation("DeptManagers", fields: [managerOfDeptId], references: [id])

  // Biometric & System
  deviceUserId    String?
  sourceEmployeeId String?
  dateOfJoining   DateTime?
  status          String           @default("active") // active, resigned, terminated
  
  user            User?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  isActive        Boolean          @default(true)
  bankName        String?
  categoryId      String?
  category        Category?        @relation(fields: [categoryId], references: [id])
  shiftId         String?
  shift           Shift?           @relation(fields: [shiftId], references: [id])
  
  // Legacy Salary Fields
  basicSalary     Float            @default(0)
  hra             Float            @default(0)
  otherAllowances Float            @default(0)
  standardDeductions Float         @default(0) // New field
  isOTEnabled     Boolean          @default(true)
  otRateMultiplier Float           @default(1.0)
  isPFEnabled     Boolean          @default(true)
  isESIEnabled    Boolean          @default(true)
  isPTEnabled     Boolean          @default(true)
  
  // Bank & IDs
  accountNumber   String?
  ifscCode        String?
  panNumber       String?
  aadhaarNumber   String?
  
  attendanceLogs  AttendanceLog[]
  employeeShifts  EmployeeShift[]
  payslips        Payslip[]
  leaveEntries    LeaveEntry[]
  managedLeaves   LeaveEntry[] @relation("ManagerLeaveApproval")
  ceoLeaves       LeaveEntry[] @relation("CeoLeaveApproval")
  leaveBalances   LeaveBalance[]
  fieldLogs       FieldLog[]
  payrolls        Payroll[]
  salaryComponents EmployeeSalaryComponent[]
  documents       EmployeeDocument[]
  loans           Loan[]

  @@unique([employeeCode, tenantId])
  @@unique([sourceEmployeeId, tenantId])
}

// --------------------------------------------------------
// ATTENDANCE & SHIFTS
// --------------------------------------------------------

model Shift {
  id              String    @id @default(uuid())
  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [id])
  name            String
  code            String?
  startTime       DateTime  @db.Time
  endTime         DateTime  @db.Time
  breakDuration   Int       @default(60) // in minutes
  gracePeriodIn   Int       @default(0)
  gracePeriodOut  Int       @default(0)
  isNightShift    Boolean   @default(false)
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  employees       Employee[]

  employeeShifts  EmployeeShift[]

  @@unique([code, tenantId])
}

model EmployeeShift {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  shiftId     String
  shift       Shift     @relation(fields: [shiftId], references: [id])
  startDate   DateTime
  endDate     DateTime? // Null means ongoing
  isDefault   Boolean   @default(false)
  updatedAt   DateTime  @updatedAt

  @@index([tenantId])
}

model AttendanceLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  date        DateTime @db.Date // key for the day
  firstIn     DateTime?
  lastOut     DateTime?
  totalHours  Float    @default(0)
  workingHours Float   @default(0)
  lateArrival Float    @default(0)
  earlyDeparture Float @default(0)
  status      String   @default("Absent") // Present, Absent, Half Day, Late, Holiday, WeekOff
  
  logs        String?  // JSON array of all raw punch times for investigation
  totalPunches Int     @default(0)
  shiftStart   DateTime?
  shiftEnd     DateTime?
  rawData      String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([employeeId, date, tenantId])
}

model Holiday {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  date        DateTime @db.Date
  type        String   @default("Public") // Public, Company, etc.
  description String?
  isRecurring Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  @@unique([date, tenantId])
}

// --------------------------------------------------------
// LEAVE MANAGEMENT
// --------------------------------------------------------

model LeaveType {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  isPaid      Boolean  @default(true)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  leaveEntries LeaveEntry[]

  @@unique([code, tenantId])
}

model LeaveEntry {
  id                String       @id @default(uuid())
  tenantId          String
  tenant            Tenant       @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee     @relation(fields: [employeeId], references: [id])
  leaveTypeId       String?
  leaveType         LeaveType?   @relation(fields: [leaveTypeId], references: [id])
  startDate         DateTime
  endDate           DateTime
  days              Int          @default(1)
  reason            String?
  status            String       @default("pending") // pending, pending_manager, pending_ceo, approved, rejected
  
  managerApproval   Boolean      @default(false)
  managerApprovedAt DateTime?
  managerId         String?
  manager           Employee?    @relation("ManagerLeaveApproval", fields: [managerId], references: [id])
  
  ceoApproval       Boolean      @default(false)
  ceoApprovedAt     DateTime?
  ceoId             String?
  ceo               Employee?    @relation("CeoLeaveApproval", fields: [ceoId], references: [id])
  
  rejectionReason   String?
  updatedAt         DateTime     @updatedAt

  @@index([tenantId])
}

model LeaveBalance {
  id           String       @id @default(uuid())
  tenantId     String
  tenant       Tenant       @relation(fields: [tenantId], references: [id])
  code         String
  description  String?
  employeeId   String
  employee     Employee     @relation(fields: [employeeId], references: [id])
  year         Int
  total        Float        @default(0)
  used         Float        @default(0)
  balance      Float        @default(0)
  
  transactions LeaveBalanceTransaction[]

  @@unique([code, employeeId, year, tenantId])
}

model LeaveBalanceTransaction {
  id             String       @id @default(uuid())
  leaveBalanceId String
  leaveBalance   LeaveBalance @relation(fields: [leaveBalanceId], references: [id])
  date           DateTime
  type           String       // CREDIT, DEBIT
  amount         Float
  reason         String?
  createdAt      DateTime     @default(now())
}

// --------------------------------------------------------
// PAYROLL SYSTEM
// --------------------------------------------------------

model SalaryComponent {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  name              String
  code              String   // e.g., BASIC, HRA, PF_EMP
  type              String   // EARNING, DEDUCTION
  calculationType   String   // FLAT, PERCENTAGE, FORMULA
  value             Float?   // For flat/percentage
  formula           String?  // e.g., "BASIC * 0.12"
  isActive          Boolean  @default(true)
  
  employeeLinks     EmployeeSalaryComponent[]

  @@unique([code, tenantId])
}

model EmployeeSalaryComponent {
  id                String          @id @default(uuid())
  tenantId          String
  tenant            Tenant          @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee        @relation(fields: [employeeId], references: [id])
  componentId       String
  component         SalaryComponent @relation(fields: [componentId], references: [id])
  monthlyAmount     Float           @default(0)
  isActive          Boolean         @default(true)
  formula           String?
  
  @@unique([employeeId, componentId])
}

model PayrollSetting {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  key               String   // e.g., PF_LIMIT, ESI_LIMIT, PT_SLABS
  value             String   // JSON string of config
  description       String?
  updatedAt         DateTime @updatedAt

  @@unique([key, tenantId])
}

model PayrollRun {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  month             Int
  year              Int
  periodStart       DateTime?
  periodEnd         DateTime?
  status            String    @default("DRAFT") // DRAFT, LOCKED, PROCESSED, PAID
  processedAt       DateTime?
  processedBy       String?
  approvedAt        DateTime?
  totalNet          Float     @default(0)
  totalEmployees    Int       @default(0)
  totalGross        Float     @default(0)
  batchName         String?
  approvedBy        String?
  payrolls          Payroll[]
  payslips          Payslip[]
  createdAt         DateTime  @default(now())

  @@unique([month, year, tenantId])
}

model Payslip {
  id              String           @id @default(uuid())
  tenantId        String
  tenant          Tenant           @relation(fields: [tenantId], references: [id])
  name            String
  payrollRunId    String
  payrollRun      PayrollRun       @relation(fields: [payrollRunId], references: [id])
  employeeId      String
  employee        Employee         @relation(fields: [employeeId], references: [id])
  
  grossSalary     Float
  totalDeductions Float
  netSalary       Float
  
  details         String           // JSON Blob of all components (Basic: 5000, HRA: 2000, etc) for freezing history
  
  generatedAt     DateTime         @default(now())

  @@unique([employeeId, payrollRunId])
}

// --------------------------------------------------------
// DEVICE & SYNC
// --------------------------------------------------------

model Device {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  name            String
  protocol        String         @default("ESSL_ADMS") // ESSL_ADMS, MATRIX_DIRECT, REALTIME_DIRECT, HIKVISION_DIRECT, SQL_MIRROR
  ipAddress       String?
  port            Int?
  deviceId        String
  username        String?
  password        String?
  location        String?
  status          String         @default("offline")
  isActive        Boolean        @default(true)
  lastSeen        DateTime?
  config          String?        // JSON for extra properties (e.g. SQL Table name)
  
  rawDeviceLogs   RawDeviceLog[]
  commands        DeviceCommand[]

  @@unique([deviceId, tenantId])
}

model RawDeviceLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id])
  
  deviceUserId String
  userId       String?   // Legacy/Alternative field
  timestamp    DateTime
  punchTime    DateTime? // Legacy/Alternative field
  punchType    String?  // CheckIn, CheckOut, etc.
  
  isProcessed  Boolean  @default(false)
  processedAt  DateTime?
  
  createdAt    DateTime @default(now())

  @@unique([deviceId, deviceUserId, timestamp, tenantId])
  @@index([isProcessed])
  @@index([tenantId])
  @@index([userId])
  @@index([punchTime])
}

model DeviceCommand {
  id           String    @id @default(uuid())
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  deviceId     String
  device       Device    @relation(fields: [deviceId], references: [id])
  command      String
  status       String    @default("pending")
  response     String?   // Device response if any
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  sentAt       DateTime?

  @@index([deviceId, status])
  @@index([tenantId])
}

model SyncLog {
  id            String   @id @default(uuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  status        String   // SUCCESS, FAILED
  message       String?
  recordCount   Int      @default(0)
  lastSyncTime  DateTime
  createdAt     DateTime @default(now())

  @@index([tenantId])
}

model AuditLog {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  action      String
  module      String
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  details     String?  // JSON
  description String?  // Adding description as it's used in ceo.ts
  createdAt   DateTime @default(now())

  @@index([tenantId])
}

model Payroll {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee  @relation(fields: [employeeId], references: [id])
  month             Int
  year              Int
  totalWorkingDays  Int       @default(0)
  actualPresentDays Float     @default(0)
  lopDays           Float     @default(0)
  paidDays          Float     @default(0)
  grossSalary       Float     @default(0)
  totalDeductions   Float     @default(0)
  netSalary         Float     @default(0)
  status            String    @default("generated")
  basicPaid         Float     @default(0)
  hraPaid           Float     @default(0)
  allowancesPaid    Float     @default(0)
  pfDeduction       Float     @default(0)
  esiDeduction      Float     @default(0)
  ptDeduction       Float     @default(0)
  employerPF        Float     @default(0)
  employerESI       Float     @default(0)
  otHours           Float     @default(0)
  otPay             Float     @default(0)
  loanDeduction     Float     @default(0) // Added for Loan Management
  payrollRunId      String?
  payrollRun        PayrollRun? @relation(fields: [payrollRunId], references: [id])
  loanDeductions    LoanDeduction[]
  createdAt         DateTime  @default(now())

  @@unique([employeeId, month, year, tenantId])
}

model Loan {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  employeeId      String
  employee        Employee       @relation(fields: [employeeId], references: [id])
  amount          Float          // Principal
  interestRate    Float          @default(0)
  tenureMonths    Int
  monthlyDeduction Float
  startDate       DateTime
  status          String         @default("ACTIVE") // ACTIVE, COMPLETED, CLOSED
  
  repaidAmount    Float          @default(0)
  balanceAmount   Float
  
  deductions      LoanDeduction[]
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}

model LoanDeduction {
  id              String         @id @default(uuid())
  tenantId        String
  tenant          Tenant         @relation(fields: [tenantId], references: [id])
  loanId          String
  loan            Loan           @relation(fields: [loanId], references: [id])
  payrollId       String
  payroll         Payroll        @relation(fields: [payrollId], references: [id])
  amount          Float
  date            DateTime       @default(now())

  @@index([loanId])
}

model CompanyProfile {
  id             String   @id @default(uuid())
  tenantId       String   @unique
  tenant         Tenant   @relation(fields: [tenantId], references: [id])
  name           String
  legalName      String?
  logo           String?
  address        String?
  city           String?
  state          String?
  country        String?
  pincode        String?
  phone          String?
  email          String?
  website        String?
  taxId          String? // Generic Tax ID
  registrationId String? // Generic Registration ID
  
  // Specific Indian Compliance Fields
  gstin          String?
  pan            String?
  pfCode         String?
  esiCode        String?
  tan            String?
  
  // Bank Details
  bankName       String?
  accountNumber  String?
  ifscCode       String?
  
  updatedAt      DateTime @updatedAt
}

model FieldLog {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id])
  employeeId        String
  employee          Employee  @relation(fields: [employeeId], references: [id])
  projectId         String?
  project           Project?  @relation(fields: [projectId], references: [id])
  
  type              String    @default("IN") // IN or OUT
  timestamp         DateTime  @default(now())
  
  location          String?   // JSON {lat, lng, address}
  image             String?   // Base64 or URL
  remarks           String?
  status            String    @default("pending") // pending, approved, rejected
  
  approvedBy        String?
  approvedAt        DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId])
}

model Project {
  id          String    @id @default(uuid())
  tenantId    String
  tenant      Tenant    @relation(fields: [tenantId], references: [id])
  name        String
  code        String
  description String?
  clientName  String?
  startDate   DateTime?
  endDate     DateTime?
  status      String    @default("ACTIVE") // ACTIVE, COMPLETED, ON_HOLD
  
  latitude    Float?
  longitude   Float?
  radius      Int       @default(200) // Geofence radius
  
  fieldLogs   FieldLog[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([code, tenantId])
}

model EmployeeDocument {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  employeeId  String
  employee    Employee @relation(fields: [employeeId], references: [id])
  
  type        String   // Offer Letter, ID Proof, etc.
  name        String   // Display Name
  url         String   // File Path relative to uploads/
  mimeType    String?
  size        Int?
  
  uploadedBy  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([employeeId])
}
