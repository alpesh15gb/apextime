generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String     @id @default(uuid())
  username   String     @unique
  password   String
  role       String     @default("admin") // admin, manager, employee
  employeeId String?    @unique // Link to employee record if any
  employee   Employee?  @relation(fields: [employeeId], references: [id])
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  auditLogs  AuditLog[]
}

model Location {
  id        String   @id @default(uuid())
  name      String
  address   String?
  city      String?
  state     String?
  country   String?
  zipCode   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  branches  Branch[]
}

model Branch {
  id          String       @id @default(uuid())
  name        String
  code        String       @unique
  locationId  String?
  location    Location?    @relation(fields: [locationId], references: [id])
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  employees   Employee[]
  departments Department[]
}

model Department {
  id          String     @id @default(uuid())
  name        String
  code        String
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  managerId   String?
  manager     Employee?  @relation("DeptManager", fields: [managerId], references: [id])
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[] @relation("EmployeeDept")

  @@unique([code, branchId])
}

model Designation {
  id          String     @id @default(uuid())
  name        String
  code        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]
}

model Category {
  id          String     @id @default(uuid())
  name        String
  code        String     @unique
  description String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  employees   Employee[]
}

model Employee {
  id               String       @id @default(uuid())
  employeeCode     String       @unique
  firstName        String
  lastName         String
  email            String?
  phone            String?
  branchId         String?
  branch           Branch?      @relation(fields: [branchId], references: [id])
  departmentId     String?
  department       Department?  @relation("EmployeeDept", fields: [departmentId], references: [id])
  designationId    String?
  designation      Designation? @relation(fields: [designationId], references: [id])
  categoryId       String?
  category         Category?    @relation(fields: [categoryId], references: [id])
  shiftId          String?
  shift            Shift?       @relation(fields: [shiftId], references: [id])
  deviceUserId     String?
  sourceEmployeeId String?      @unique
  dateOfJoining    DateTime?
  isActive         Boolean      @default(true)
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  user User?

  // Multi-level approval relations
  managedDepartments    Department[] @relation("DeptManager")
  managerApprovedLeaves LeaveEntry[] @relation("ManagerApprovedLeaves")
  ceoApprovedLeaves     LeaveEntry[] @relation("CEOApprovedLeaves")

  attendanceLogs AttendanceLog[]
  leaveEntries   LeaveEntry[]
  employeeShifts EmployeeShift[]
  payrolls       Payroll[]

  // Salary Fields (Fixed)
  basicSalary        Float @default(0)
  hra                Float @default(0)
  conveyance         Float @default(0)
  medicalAllowance   Float @default(0)
  specialAllowance   Float @default(0)
  otherAllowances    Float @default(0)
  standardDeductions Float @default(0)

  // Banking Details
  bankName      String?
  accountNumber String?
  ifscCode      String?
  panNumber     String?
  aadhaarNumber String?

  // Advanced Payroll Configuration
  isPFEnabled      Boolean @default(false)
  isESIEnabled     Boolean @default(false)
  isPTEnabled      Boolean @default(true) // Professional Tax
  isOTEnabled      Boolean @default(false)
  otRateMultiplier Float   @default(1.5)

  fieldLogs FieldLog[]
}

model FieldLog {
  id         String    @id @default(uuid())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  type       String // IN, OUT
  timestamp  DateTime  @default(now())
  location   String? // lat,lng or address
  image      String? // Base64 or URL
  status     String    @default("pending") // pending, approved, rejected
  remarks    String?
  processed  Boolean   @default(false)
  approvedBy String?
  approvedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([employeeId, timestamp])
  @@index([status])
}

model CompanyProfile {
  id            String   @id @default(uuid())
  name          String
  legalName     String?
  address       String?
  logo          String?
  gstin         String?
  pan           String?
  pfCode        String?
  esiCode       String?
  tan           String?
  bankName      String?
  accountNumber String?
  ifscCode      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  action      String // e.g., 'SALARY_UPDATE', 'LEAVE_APPROVE', 'PUNCH_OVERRIDE'
  entityId    String? // ID of the employee/leave/payroll being touched
  entityType  String // 'Employee', 'LeaveEntry', etc.
  description String
  metadata    String? // JSON string of before/after values
  oldValue    String?
  newValue    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([createdAt])
}

model Shift {
  id             String          @id @default(uuid())
  name           String
  startTime      String
  endTime        String
  gracePeriodIn  Int             @default(0)
  gracePeriodOut Int             @default(0)
  isNightShift   Boolean         @default(false)
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  employees      Employee[]
  employeeShifts EmployeeShift[]
}

model EmployeeShift {
  id         String    @id @default(uuid())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id])
  shiftId    String
  shift      Shift     @relation(fields: [shiftId], references: [id])
  startDate  DateTime
  endDate    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Holiday {
  id          String   @id @default(uuid())
  name        String
  date        DateTime
  description String?
  isRecurring Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LeaveType {
  id           String       @id @default(uuid())
  name         String
  code         String       @unique
  description  String?
  isPaid       Boolean      @default(true)
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  leaveEntries LeaveEntry[]
}

model LeaveEntry {
  id          String    @id @default(uuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  leaveTypeId String
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])
  startDate   DateTime
  endDate     DateTime
  days        Float
  reason      String?
  status      String    @default("pending_manager") // pending_manager, pending_ceo, approved, rejected

  managerApproval   Boolean?
  managerApprovedAt DateTime?
  managerId         String?
  manager           Employee? @relation("ManagerApprovedLeaves", fields: [managerId], references: [id])

  ceoApproval   Boolean?
  ceoApprovedAt DateTime?
  ceoId         String?
  ceo           Employee? @relation("CEOApprovedLeaves", fields: [ceoId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Device {
  id            String         @id @default(uuid())
  deviceId      String         @unique
  name          String
  ipAddress     String?
  port          Int?
  location      String?
  status        String         @default("offline")
  lastConnected DateTime?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  deviceUsers   DeviceUser[]
  rawDeviceLogs RawDeviceLog[]
}

model DeviceUser {
  id           String   @id @default(uuid())
  deviceId     String
  device       Device   @relation(fields: [deviceId], references: [id])
  deviceUserId String
  employeeId   String?
  name         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([deviceId, deviceUserId])
}

model RawDeviceLog {
  id          String   @id @default(uuid())
  deviceId    String
  device      Device   @relation(fields: [deviceId], references: [id])
  userId      String
  punchTime   DateTime
  punchType   String?
  isProcessed Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([punchTime])
  @@index([userId, punchTime])
  @@index([isProcessed])
}

model AttendanceLog {
  id             String    @id @default(uuid())
  employeeId     String
  employee       Employee  @relation(fields: [employeeId], references: [id])
  date           DateTime
  firstIn        DateTime?
  lastOut        DateTime?
  workingHours   Float?
  shiftStart     DateTime?
  shiftEnd       DateTime?
  lateArrival    Int       @default(0)
  earlyDeparture Int       @default(0)
  status         String    @default("present")
  totalPunches   Int       @default(0)
  rawData        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([employeeId, date])
  @@index([date])
  @@index([employeeId])
}

model SyncStatus {
  id            String   @id @default(uuid())
  lastSyncTime  DateTime
  recordsSynced Int      @default(0)
  status        String
  message       String?
  createdAt     DateTime @default(now())
}

model Payroll {
  id                String   @id @default(uuid())
  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id])
  month             Int
  year              Int
  totalWorkingDays  Int
  actualPresentDays Float
  lopDays           Float    @default(0) // Loss of Pay Days
  paidDays          Float

  basicPaid      Float
  hraPaid        Float
  conveyancePaid Float @default(0)
  medicalPaid    Float @default(0)
  specialPaid    Float @default(0)
  allowancesPaid Float

  // Variable Components
  bonus      Float @default(0)
  incentives Float @default(0)
  arrears    Float @default(0)

  // Overtime
  otHours Float @default(0)
  otPay   Float @default(0)

  // Deductions (Employee Share)
  pfDeduction     Float @default(0)
  esiDeduction    Float @default(0)
  ptDeduction     Float @default(0) // Professional Tax
  tdsDeduction    Float @default(0)
  otherDeductions Float @default(0)

  // Employer Contributions
  employerPF  Float @default(0)
  employerESI Float @default(0)

  grossSalary     Float
  totalDeductions Float
  netSalary       Float

  status    String    @default("draft") // draft, generated, paid
  remarks   String?
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([employeeId, month, year])
}
